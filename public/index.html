<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linux Campaign — Local (No Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',sans-serif;background:#eef3f7;}
    .glass{background:rgba(255,255,255,.55);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.35);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.07);}
    .card{background:#fff;border-radius:16px;border:1px solid #e5e7eb;}
    .nav-item.active{background:#fff;color:#1e3a8a;box-shadow:0 1px 10px rgba(0,0,0,.06);}
    .loader{border:4px solid rgba(0,0,0,.08);border-top:4px solid #111827;border-radius:50%;width:22px;height:22px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-gray-800">

  <!-- Login -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-50">
    <div class="glass w-full max-w-md p-8 text-center">
      <h1 class="text-3xl font-extrabold">Linux <span class="text-blue-600">Campaign</span></h1>
      <p class="text-gray-600 mt-3">تسجيل دخول محلي (بدون Firebase)</p>
      <div class="text-right mt-6 space-y-4">
        <div>
          <label class="text-sm font-medium">المستخدم</label>
          <input id="adminUser" class="w-full mt-1 p-3 border rounded-lg" placeholder="admin">
        </div>
        <div>
          <label class="text-sm font-medium">كلمة المرور</label>
          <input id="adminPass" type="password" class="w-full mt-1 p-3 border rounded-lg" placeholder="••••••••">
        </div>
        <button id="adminLoginBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold">دخول</button>
        <p id="loginError" class="hidden text-red-600 text-sm">بيانات الدخول غير صحيحة.</p>
        <p class="text-xs text-gray-500">⚠️ مخصّص للاختبار فقط.</p>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden h-screen">
    <div class="h-full grid grid-cols-[260px_1fr]">
      <aside class="glass p-4" id="sidebar">
        <div class="h-16 flex items-center justify-center border-b">
          <h2 class="font-extrabold text-xl">Linux <span class="text-blue-600">Campaign</span></h2>
        </div>
        <nav class="pt-4 space-y-2">
          <a href="#dashboard" id="navDashboard" class="nav-item block px-4 py-2 rounded-lg">لوحة المعلومات</a>
          <a href="#audience"  id="navAudience"  class="nav-item block px-4 py-2 rounded-lg">الجمهور</a>
          <a href="#content"   id="navContent"   class="nav-item block px-4 py-2 rounded-lg">المحتوى</a>
          <a href="#campaigns" id="navCampaigns" class="nav-item block px-4 py-2 rounded-lg">إنشاء حملة</a>
          <a href="#reports"   id="navReports"   class="nav-item block px-4 py-2 rounded-lg">التقارير</a>
        </nav>
        <div class="pt-4 border-t mt-4">
          <a href="#settings" id="navSettings" class="nav-item block px-4 py-2 rounded-lg">الإعدادات</a>
        </div>
      </aside>

      <div class="flex flex-col">
        <header class="glass h-16 px-6 flex items-center justify-between">
          <h3 id="pageTitle" class="text-xl font-bold"></h3>
          <div class="flex items-center gap-3">
            <span id="pageName" class="text-gray-600">غير متصل</span>
            <span id="statusDot" class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
          </div>
        </header>

        <div id="bannerDisconnected" class="hidden bg-yellow-100 border-y border-yellow-300 text-yellow-900 px-4 py-2">
          غير متصل. أدخل Page ID و Access Token من الإعدادات.
        </div>

        <main id="viewRoot" class="p-6 overflow-y-auto"></main>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tpl-dashboard">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card p-6"><p class="text-gray-500">إجمالي الجمهور</p><p id="statTotal" class="text-3xl font-bold mt-2">0</p></div>
      <div class="card p-6"><p class="text-gray-500">الحملات المرسلة</p><p id="statSent" class="text-3xl font-bold mt-2">0</p></div>
      <div class="card p-6"><p class="text-gray-500">معدل النجاح</p><p id="statRate" class="text-3xl font-bold mt-2">0%</p></div>
    </div>
  </template>

  <template id="tpl-audience">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 space-y-4">
        <div class="glass p-4 flex items-center justify-between">
          <div class="font-bold">مركز التحكم بالجمهور</div>
          <div class="flex items-center gap-3">
            <span class="text-gray-600">المجموع: <b id="audCount">0</b></span>
            <button id="btnFetch" class="px-4 py-2 bg-blue-600 text-white rounded-lg">بدء السحب</button>
          </div>
        </div>
        <div class="glass p-0">
          <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
              <tr><th class="p-3 w-10"></th><th class="p-3 text-right">المستخدم</th><th class="p-3 text-right">ID</th></tr>
            </thead>
            <tbody id="audTable" class="divide-y"></tbody>
          </table>
        </div>
      </div>
      <div class="glass p-4">
        <div class="font-bold mb-2">قوائم الجمهور المحفوظة</div>
        <div class="space-y-2" id="audSaved"></div>
        <div class="pt-3">
          <button id="btnSaveAud" class="px-4 py-2 bg-yellow-500 text-white rounded-lg disabled:opacity-50">حفظ المحددين</button>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-content">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass p-4">
        <div class="font-bold mb-3">مكتبة الصور</div>
        <div class="space-y-3">
          <input id="imgName" class="w-full p-2 border rounded" placeholder="اسم الصورة" />
          <input id="imgFile" type="file" accept="image/*" />
          <button id="btnSaveImg" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حفظ الصورة</button>
        </div>
        <div id="imgList" class="mt-4 space-y-2"></div>
      </div>
      <div class="glass p-4">
        <div class="font-bold mb-3">مكتبة النصوص</div>
        <div class="space-y-3">
          <input id="capName" class="w-full p-2 border rounded" placeholder="اسم النص" />
          <textarea id="capText" class="w-full p-2 border rounded h-28" placeholder="النص"></textarea>
          <button id="btnSaveCap" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حفظ النص</button>
        </div>
        <div id="capList" class="mt-4 space-y-2"></div>
      </div>
    </div>
  </template>

  <template id="tpl-campaigns">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium">اختر جمهورك</label>
          <select id="ddAudience" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">الصورة</label>
          <select id="ddImage" class="w-full p-2 border rounded"></select>
          <input id="imgUrl" class="w-full p-2 border rounded mt-2" placeholder="أو أدخل رابط صورة"/>
        </div>
        <div>
          <label class="block text-sm font-medium">النص</label>
          <select id="ddCaption" class="w-full p-2 border rounded"></select>
          <textarea id="msgText" class="w-full p-2 border rounded mt-2 h-28" placeholder="أو اكتب رسالتك"></textarea>
        </div>
        <div class="flex items-end gap-3">
          <div>
            <label class="block text-sm font-medium">الفاصل (ثانية)</label>
            <input id="delay" type="number" value="5" min="1" class="w-28 p-2 border rounded" />
          </div>
          <button id="btnStart" class="px-6 py-3 bg-blue-600 text-white rounded-lg">إرسال الحملة</button>
        </div>
      </div>
      <div class="glass p-4">
        <div class="font-bold">قائمة الإرسال (<span id="targetCount">0</span>)</div>
        <div id="sendList" class="mt-3 space-y-2 max-h-[50vh] overflow-y-auto"></div>
      </div>
    </div>
  </template>

  <template id="tpl-reports">
    <div id="reportsWrap" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="noReports" class="hidden text-center text-gray-500 mt-8">لا توجد تقارير بعد.</p>
  </template>

  <template id="tpl-settings">
    <div class="max-w-xl space-y-4">
      <div class="glass p-6">
        <div class="font-bold text-lg mb-3">إعدادات الاتصال</div>
        <div class="space-y-3">
          <input id="pageId" class="w-full p-2 border rounded" placeholder="Page ID" />
          <input id="accessToken" class="w-full p-2 border rounded" placeholder="Page Access Token" />
          <button id="btnConnect" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حفظ والاتصال</button>
        </div>
      </div>
      <div class="glass p-6">
        <div class="font-bold mb-2">جلسة المستخدم</div>
        <div class="flex items-center gap-3">
          <span>admin</span>
          <button id="btnLogout" class="px-4 py-2 bg-gray-700 text-white rounded-lg">تسجيل الخروج</button>
        </div>
      </div>
    </div>
  </template>

  <div id="modal" class="hidden fixed inset-0 bg-black/50 z-[60] items-center justify-center">
    <div class="glass p-6 max-w-md w-full">
      <h4 id="mTitle" class="font-bold text-lg mb-2"></h4>
      <p id="mMsg" class="text-gray-700 whitespace-pre-wrap"></p>
      <div class="text-left mt-4"><button id="mOk" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حسنًا</button></div>
    </div>
  </div>

  <script>
    // ====== Local state (no Firebase)
    const LS = {
      get: (k, d) => { try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      del: (k) => localStorage.removeItem(k)
    };
    const ST = {
      connected: false,
      pageId: LS.get('lc_pageId', null),
      token:  LS.get('lc_token', null),
      users:  LS.get('lc_users', []),       // [{id,name,picture}]
      images: LS.get('lc_images', []),      // [{id,name,url(Base64)}]
      captions: LS.get('lc_captions', []),  // [{id,name,text}]
      audiences: LS.get('lc_audiences', []),// [{id,name,userIds:[]}]
      campaigns: LS.get('lc_campaigns', []),
      selected: new Set(),
      sending: {running:false,paused:false,idx:0,targets:[],job:null}
    };

    // ====== Helpers/UI
    const $  = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
    function toast(title, msg){
      $('#mTitle').textContent = title; $('#mMsg').textContent = msg||'';
      $('#modal').classList.remove('hidden'); $('#mOk').onclick = ()=>$('#modal').classList.add('hidden');
    }
    function setConnectedUI(yes, name){
      $('#pageName').textContent = yes ? (name||'متصل') : 'غير متصل';
      $('#statusDot').classList.toggle('bg-green-500', yes);
      $('#statusDot').classList.toggle('bg-red-500', !yes);
      $('#bannerDisconnected').classList.toggle('hidden', yes);
    }

    // ====== Login (local only)
    function doLogin(){
      const u = $('#adminUser').value.trim();
      const p = $('#adminPass').value.trim();
      if(u==='admin' && p==='mO..012842'){
        localStorage.setItem('lc_logged','1');
        $('#loginOverlay').classList.add('hidden');
        $('#app').classList.remove('hidden');
        initAfterLogin();
      }else{
        $('#loginError').classList.remove('hidden');
      }
    }

    // ====== Router/Views
    const views = {
      dashboard(root){
        root.innerHTML = $('#tpl-dashboard').innerHTML;
        $('#statTotal').textContent = ST.users.length;
        const sent = ST.campaigns.reduce((a,c)=>a+(c.successCount||0),0);
        const total= ST.campaigns.reduce((a,c)=>a+((c.successCount||0)+(c.failureCount||0)),0);
        $('#statSent').textContent = sent;
        $('#statRate').textContent = total? Math.round((sent/total)*100)+'%':'0%';
      },
      audience(root){
        root.innerHTML = $('#tpl-audience').innerHTML;
        $('#audCount').textContent = ST.users.length;
        renderAudienceTable();
        $('#btnFetch').onclick = fetchUsers;
        $('#btnSaveAud').onclick = saveSelectedAudience;
      },
      content(root){
        root.innerHTML = $('#tpl-content').innerHTML;
        $('#btnSaveImg').onclick = saveImage;
        $('#btnSaveCap').onclick = saveCaption;
        renderImgs(); renderCaps();
      },
      campaigns(root){
        root.innerHTML = $('#tpl-campaigns').innerHTML;
        fillCampaignDropdowns();
        $('#btnStart').onclick = startCampaign;
      },
      reports(root){
        root.innerHTML = $('#tpl-reports').innerHTML;
        renderReports();
      },
      settings(root){
        root.innerHTML = $('#tpl-settings').innerHTML;
        $('#pageId').value = ST.pageId || '';
        $('#accessToken').value = ST.token || '';
        $('#btnConnect').onclick = () => connect($('#pageId').value.trim(), $('#accessToken').value.trim());
        $('#btnLogout').onclick  = () => { localStorage.removeItem('lc_logged'); location.reload(); };
      }
    };

    function render(){
      const v = (location.hash||'#dashboard').slice(1);
      $$('.nav-item').forEach(a=>a.classList.remove('active'));
      $('#nav'+v.charAt(0).toUpperCase()+v.slice(1))?.classList.add('active');
      $('#pageTitle').textContent = $('#nav'+v.charAt(0).toUpperCase()+v.slice(1))?.textContent || '';
      views[v]?.($('#viewRoot'));
    }
    window.addEventListener('hashchange', render);

    // ====== Connect to Graph
    async function connect(pageId, token){
      if(!pageId || !token) return toast('خطأ','أدخل Page ID و Access Token');
      try{
        const res = await fetch(`https://graph.facebook.com/v20.0/${pageId}?fields=name,picture.type(small)&access_token=${encodeURIComponent(token)}`);
        const data = await res.json();
        if(!res.ok || data.error) throw new Error(data.error?.message || ('HTTP '+res.status));
        ST.pageId = pageId; ST.token = token; ST.connected = true;
        LS.set('lc_pageId', pageId); LS.set('lc_token', token);
        setConnectedUI(true, data.name);
        toast('تم الاتصال', `متصل الآن بصفحة ${data.name}`);
      }catch(e){
        setConnectedUI(false);
        toast('فشل الاتصال', e.message);
      }
    }

    // ====== Audience
    function renderAudienceTable(){
      const body = $('#audTable'); body.innerHTML='';
      ST.users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-3"><input type="checkbox" data-id="${u.id}"></td>
                        <td class="p-3"><div class="flex items-center gap-2">
                          <img src="${u.picture||'https://placehold.co/40'}" class="w-8 h-8 rounded"/><b>${u.name||'User'}</b></div></td>
                        <td class="p-3 font-mono text-gray-600">${u.id}</td>`;
        body.appendChild(tr);
      });
      $('#audCount').textContent = ST.users.length;
      body.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.onchange = (e)=>{
        const id = e.target.dataset.id;
        if(e.target.checked) ST.selected.add(id); else ST.selected.delete(id);
      });
    }

    async function fetchUsers(){
      if(!ST.connected) return toast('غير متصل','ادخل الإعدادات أولاً.');
      let next = `https://graph.facebook.com/v20.0/${ST.pageId}/conversations?fields=participants{name,id,picture.type(square)}&limit=100&access_token=${encodeURIComponent(ST.token)}`;
      const seen = new Set(ST.users.map(u=>u.id));
      try{
        while(next){
          const res = await fetch(next);
          const data = await res.json();
          if(data.error) throw new Error(data.error.message);
          (data.data||[]).forEach(conv=>{
            const u = (conv.participants?.data||[]).find(p=>p.id!==ST.pageId);
            if(u && !seen.has(u.id)){ seen.add(u.id); ST.users.push({id:u.id, name:u.name, picture:u.picture?.data?.url}); }
          });
          next = data.paging?.next;
          LS.set('lc_users', ST.users);
          renderAudienceTable();
        }
      }catch(e){ toast('خطأ في السحب', e.message); }
    }

    // ====== Content (localStorage)
    function renderImgs(){
      const list = $('#imgList'); list.innerHTML='';
      ST.images.forEach(img=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between py-1';
        row.innerHTML = `<div class="flex items-center gap-2">
            <img src="${img.url}" class="w-10 h-10 rounded object-cover"><b>${img.name}</b></div>
          <button class="text-red-600" data-id="${img.id}">حذف</button>`;
        row.querySelector('button').onclick = ()=>{ ST.images = ST.images.filter(x=>x.id!==img.id); LS.set('lc_images', ST.images); renderImgs(); };
        list.appendChild(row);
      });
    }
    function renderCaps(){
      const list = $('#capList'); list.innerHTML='';
      ST.captions.forEach(c=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between py-1';
        row.innerHTML = `<div><b>${c.name}</b><div class="text-gray-500 text-sm max-w-sm truncate">${c.text}</div></div>
          <button class="text-red-600" data-id="${c.id}">حذف</button>`;
        row.querySelector('button').onclick = ()=>{ ST.captions = ST.captions.filter(x=>x.id!==c.id); LS.set('lc_captions', ST.captions); renderCaps(); };
        list.appendChild(row);
      });
    }
    function saveImage(){
      const name = $('#imgName').value.trim();
      const file = $('#imgFile').files[0];
      if(!name || !file) return;
      const reader = new FileReader();
      reader.onload = () => {
        ST.images.push({id: crypto.randomUUID(), name, url: reader.result});
        LS.set('lc_images', ST.images); renderImgs();
        $('#imgName').value=''; $('#imgFile').value='';
      };
      reader.readAsDataURL(file);
    }
    function saveCaption(){
      const name = $('#capName').value.trim();
      const text = $('#capText').value.trim();
      if(!name || !text) return;
      ST.captions.push({id: crypto.randomUUID(), name, text});
      LS.set('lc_captions', ST.captions); renderCaps();
      $('#capName').value=''; $('#capText').value='';
    }

    // ====== Audiences
    function renderSavedAudiences(){
      const box = $('#audSaved'); if(!box) return; box.innerHTML='';
      ST.audiences.forEach(a=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between py-1';
        row.innerHTML = `<div><b>${a.name}</b> <span class="text-gray-500 text-sm">(${a.userIds.length})</span></div>
                         <button class="text-red-600" data-id="${a.id}">حذف</button>`;
        row.querySelector('button').onclick = ()=>{ ST.audiences = ST.audiences.filter(x=>x.id!==a.id); LS.set('lc_audiences', ST.audiences); renderSavedAudiences(); };
        box.appendChild(row);
      });
    }
    function saveSelectedAudience(){
      const ids = Array.from(ST.selected);
      if(ids.length===0) return toast('خطأ','حدد مستخدمين أولاً.');
      const name = prompt('اسم القائمة:'); if(!name) return;
      ST.audiences.push({id: crypto.randomUUID(), name, userIds: ids});
      LS.set('lc_audiences', ST.audiences);
      renderSavedAudiences();
      ST.selected.clear();
      toast('تم','تم حفظ القائمة.');
    }

    // ====== Campaigns (direct browser → Graph)
    function fillCampaignDropdowns(){
      const ddA = $('#ddAudience'); ddA.innerHTML = `<option value="">-- اختر جمهورًا --</option>`;
      ST.audiences.forEach(a=> ddA.add(new Option(`${a.name} (${a.userIds.length})`, a.id)));
      const ddI = $('#ddImage'); ddI.innerHTML = `<option value="">-- اختر صورة --</option>`;
      ST.images.forEach(img=> ddI.add(new Option(img.name, img.id)));
      ddI.onchange = ()=>{ const img = ST.images.find(i=>i.id===ddI.value); if(img) $('#imgUrl').value = img.url; };
      const ddC = $('#ddCaption'); ddC.innerHTML = `<option value="">-- اختر نصًا --</option>`;
      ST.captions.forEach(c=> ddC.add(new Option(c.name, c.id)));
      ddC.onchange = ()=>{ const c = ST.captions.find(x=>x.id===ddC.value); if(c) $('#msgText').value = c.text; };
      renderSendList([]);
    }
    function renderSendList(ids){
      $('#sendList').innerHTML='';
      ids.forEach(id=>{
        const div = document.createElement('div'); div.className='flex items-center justify-between p-2 border rounded';
        const u = ST.users.find(x=>x.id===id) || {name:'User', picture:'https://placehold.co/40'};
        div.innerHTML = `<div class="flex items-center gap-2"><img class="w-8 h-8 rounded" src="${u.picture}"><b>${u.name}</b></div>
                         <span id="st-${id}" class="text-sm text-gray-500">—</span>`;
        $('#sendList').appendChild(div);
      });
      $('#targetCount').textContent = ids.length;
    }
    async function startCampaign(){
      if(!ST.connected) return toast('غير متصل','أدخل الإعدادات أولاً.');
      const audId = $('#ddAudience').value;
      const audience = ST.audiences.find(a=>a.id===audId);
      if(!audience || audience.userIds.length===0) return toast('خطأ','اختر جمهورًا صحيحًا.');
      const message = $('#msgText').value.trim();
      const imageUrl = $('#imgUrl').value.trim();
      if(!message && !imageUrl) return toast('خطأ','أدخل رسالة أو صورة.');
      const delay = Math.max(1, parseInt($('#delay').value||'5',10));
      renderSendList(audience.userIds);
      ST.sending = {running:true, paused:false, idx:0, targets:[...audience.userIds], job:{
        id: crypto.randomUUID(), name:'Campaign', createdAt: Date.now(), successCount:0, failureCount:0
      }};
      await runSender(message, imageUrl, delay);
    }
    async function runSender(message, imageUrl, delay){
      const url = `https://graph.facebook.com/v20.0/me/messages?access_token=${encodeURIComponent(ST.token)}`;
      while(ST.sending.running && ST.sending.idx < ST.sending.targets.length){
        const id = ST.sending.targets[ST.sending.idx];
        $('#st-'+id)?.classList.remove('text-gray-500');
        $('#st-'+id)?.classList.add('text-yellow-700'); $('#st-'+id).textContent='...';
        try{
          const payload = { messaging_type:'RESPONSE', recipient:{id}, message:{} };
          if(message) payload.message.text = message;
          if(imageUrl) payload.message.attachment = { type:'image', payload:{ url:imageUrl, is_reusable:true } };
          const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const data = await res.json();
          if(data.error) throw new Error(data.error.message);
          ST.sending.job.successCount++;
          $('#st-'+id).textContent='✅'; $('#st-'+id).className='text-green-700';
        }catch(e){
          ST.sending.job.failureCount++;
          $('#st-'+id).textContent='❌'; $('#st-'+id).className='text-red-700';
        }
        ST.sending.idx++;
        await new Promise(r=>setTimeout(r, delay*1000));
      }
      ST.campaigns.push(ST.sending.job);
      LS.set('lc_campaigns', ST.campaigns);
      toast('انتهى الإرسال', `تم الإرسال: ${ST.sending.job.successCount}\nفشل: ${ST.sending.job.failureCount}`);
      render();
    }

    // ====== Reports
    function renderReports(){
      const wrap = $('#reportsWrap'); const empty = $('#noReports');
      wrap.innerHTML=''; if(ST.campaigns.length===0){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      ST.campaigns.slice().reverse().forEach(c=>{
        const total = (c.successCount||0)+(c.failureCount||0);
        const card = document.createElement('div'); card.className='glass p-4';
        card.innerHTML = `<div class="flex items-center justify-between">
          <b>${c.name||'Campaign'}</b><span class="text-sm">${new Date(c.createdAt).toLocaleString()}</span></div>
          <div class="mt-2 text-sm text-gray-700">تم: ${c.successCount||0} — فشل: ${c.failureCount||0} — الإجمالي: ${total}</div>`;
        wrap.appendChild(card);
      });
    }

    // ====== Boot
    function initAfterLogin(){
      setConnectedUI(!!ST.token && !!ST.pageId, null);
      renderSavedAudiences();
      window.dispatchEvent(new HashChangeEvent('hashchange'));
    }

    // events
    $('#adminLoginBtn').onclick = doLogin;
    $('#adminPass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });
    $('#mOk').onclick = ()=> $('#modal').classList.add('hidden');

    if(localStorage.getItem('lc_logged')==='1'){
      $('#loginOverlay').classList.add('hidden'); $('#app').classList.remove('hidden'); initAfterLogin();
    }else{
      $('#app').classList.add('hidden');
    }
    render(); // initial
  </script>
</body>
</html>
