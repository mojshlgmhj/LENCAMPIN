<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linux Campaign — Local (No Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',sans-serif;background:#eef3f7;}
    .glass{background:rgba(255,255,255,.55);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.35);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.07);}
    .card{background:#fff;border-radius:16px;border:1px solid #e5e7eb;}
    .nav-item.active{background:#fff;color:#1e3a8a;box-shadow:0 1px 10px rgba(0,0,0,.06);}
    .badge{font-size:.75rem;padding:.15rem .5rem;border-radius:999px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,monospace;}
  </style>
</head>
<body class="text-gray-800">

  <!-- Login -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-50">
    <div class="glass w-full max-w-md p-8 text-center">
      <h1 class="text-3xl font-extrabold">Linux <span class="text-blue-600">Campaign</span></h1>
      <p class="text-gray-600 mt-3">تسجيل دخول محلي (بدون Firebase)</p>
      <div class="text-right mt-6 space-y-4">
        <label class="block text-sm">المستخدم</label>
        <input id="adminUser" class="w-full p-3 border rounded" placeholder="admin">
        <label class="block text-sm">كلمة المرور</label>
        <input id="adminPass" type="password" class="w-full p-3 border rounded" placeholder="••••••••">
        <button id="adminLoginBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold">دخول</button>
        <p id="loginError" class="hidden text-red-600 text-sm">بيانات الدخول غير صحيحة.</p>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden h-screen">
    <div class="h-full grid grid-cols-[280px_1fr]">
      <aside class="glass p-4" id="sidebar">
        <div class="h-16 flex items-center justify-center border-b">
          <h2 class="font-extrabold text-xl">Linux <span class="text-blue-600">Campaign</span></h2>
        </div>
        <nav class="pt-4 space-y-2">
          <a href="#dashboard" id="navDashboard" class="nav-item block px-4 py-2 rounded-lg">لوحة المعلومات</a>
          <a href="#audience"  id="navAudience"  class="nav-item block px-4 py-2 rounded-lg">الجمهور</a>
          <a href="#content"   id="navContent"   class="nav-item block px-4 py-2 rounded-lg">المحتوى</a>
          <a href="#campaigns" id="navCampaigns" class="nav-item block px-4 py-2 rounded-lg">إنشاء حملة</a>
          <a href="#reports"   id="navReports"   class="nav-item block px-4 py-2 rounded-lg">التقارير</a>
        </nav>
        <div class="pt-4 border-t mt-4">
          <a href="#settings" id="navSettings" class="nav-item block px-4 py-2 rounded-lg">الإعدادات</a>
        </div>
      </aside>

      <div class="flex flex-col">
        <header class="glass h-16 px-6 flex items-center justify-between">
          <h3 id="pageTitle" class="text-xl font-bold"></h3>
          <div class="flex items-center gap-3">
            <span id="pageName" class="text-gray-600">غير متصل</span>
            <span id="statusDot" class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
          </div>
        </header>

        <div id="bannerDisconnected" class="hidden bg-yellow-100 border-y border-yellow-300 text-yellow-900 px-4 py-2">
          غير متصل. أدخل Page ID و Access Token من الإعدادات.
        </div>

        <main id="viewRoot" class="p-6 overflow-y-auto"></main>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tpl-dashboard">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="card p-6"><p class="text-gray-500">إجمالي الجمهور</p><p id="statTotal" class="text-3xl font-bold mt-2">0</p></div>
      <div class="card p-6"><p class="text-gray-500">المجموع بالمحفوظ</p><p id="statSaved" class="text-3xl font-bold mt-2">0</p></div>
      <div class="card p-6"><p class="text-gray-500">الحملات المرسلة</p><p id="statSent" class="text-3xl font-bold mt-2">0</p></div>
      <div class="card p-6"><p class="text-gray-500">معدل النجاح</p><p id="statRate" class="text-3xl font-bold mt-2">0%</p></div>
    </div>
  </template>

  <template id="tpl-audience">
    <div class="space-y-4">
      <div class="glass p-4 grid md:grid-cols-2 gap-4 items-center">
        <div class="font-bold">مركز التحكم بالجمهور</div>
        <div class="flex flex-wrap gap-2 justify-end">
          <button id="btnFetchStart"  class="px-3 py-2 bg-blue-600 text-white rounded">بدء السحب</button>
          <button id="btnFetchPause"  class="px-3 py-2 bg-yellow-500 text-white rounded">إيقاف مؤقت</button>
          <button id="btnFetchResume" class="px-3 py-2 bg-green-600 text-white rounded">استئناف</button>
          <button id="btnFetchStop"   class="px-3 py-2 bg-red-600 text-white rounded">إيقاف نهائي</button>
        </div>
        <div class="md:col-span-2 flex items-center gap-4 text-sm">
          <span>المجموع: <b id="audCount">0</b></span>
          <span>المحدد: <b id="selCount">0</b></span>
          <span class="badge bg-gray-200 text-gray-800">الحالة: <b id="fetchState">متوقف</b></span>
          <span class="badge bg-gray-200 text-gray-800">الصفحة الحالية: <b id="fetchPage">—</b></span>
          <span class="badge bg-gray-200 text-gray-800">المضاف حديثًا: <b id="fetchAdded">0</b></span>
        </div>
      </div>

      <div class="glass p-3 flex flex-wrap gap-2 items-center">
        <button id="btnSaveAud" class="px-3 py-2 bg-yellow-500 text-white rounded disabled:opacity-50">حفظ المحددين</button>
        <button id="btnExportCSV" class="px-3 py-2 bg-gray-800 text-white rounded">تصدير CSV</button>
        <button id="btnClearAll" class="px-3 py-2 bg-red-700 text-white rounded">حذف كل الجمهور</button>
        <div class="ml-auto flex gap-2 items-center">
          <input id="filterTxt" class="p-2 border rounded" placeholder="فلترة بالاسم أو ID">
          <button id="btnApplyFilter" class="px-3 py-2 bg-gray-700 text-white rounded">فلترة</button>
          <button id="btnResetFilter" class="px-3 py-2 bg-gray-500 text-white rounded">إلغاء</button>
        </div>
      </div>

      <div class="glass p-0 overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 sticky top-0">
            <tr><th class="p-3 w-10"></th><th class="p-3 text-right">المستخدم</th><th class="p-3 text-right">ID</th></tr>
          </thead>
          <tbody id="audTable" class="divide-y"></tbody>
        </table>
      </div>

      <div class="glass p-4">
        <div class="font-bold mb-2">قوائم الجمهور المحفوظة</div>
        <div class="space-y-2" id="audSaved"></div>
      </div>

      <div class="glass p-4 space-y-2">
        <div class="font-bold">استيراد IDs (كل ID في سطر)</div>
        <textarea id="idsImport" class="w-full h-32 p-2 border rounded mono" placeholder="12345&#10;67890"></textarea>
        <div class="flex gap-2">
          <button id="btnImportIds" class="px-3 py-2 bg-blue-700 text-white rounded">استيراد</button>
          <button id="btnClearImport" class="px-3 py-2 bg-gray-600 text-white rounded">تفريغ</button>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-content">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass p-4">
        <div class="font-bold mb-3">مكتبة الصور</div>
        <div class="space-y-3">
          <input id="imgName" class="w-full p-2 border rounded" placeholder="اسم الصورة" />
          <input id="imgFile" type="file" accept="image/*" />
          <button id="btnSaveImg" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حفظ الصورة</button>
        </div>
        <div id="imgList" class="mt-4 space-y-2"></div>
      </div>
      <div class="glass p-4">
        <div class="font-bold mb-3">مكتبة النصوص</div>
        <div class="space-y-3">
          <input id="capName" class="w-full p-2 border rounded" placeholder="اسم النص" />
          <textarea id="capText" class="w-full p-2 border rounded h-28" placeholder="النص"></textarea>
          <button id="btnSaveCap" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حفظ النص</button>
        </div>
        <div id="capList" class="mt-4 space-y-2"></div>
      </div>
    </div>
  </template>

  <template id="tpl-campaigns">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium">اختر جمهورك</label>
          <select id="ddAudience" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">الصورة</label>
          <select id="ddImage" class="w-full p-2 border rounded"></select>
          <input id="imgUrl" class="w-full p-2 border rounded mt-2" placeholder="أو أدخل رابط صورة"/>
        </div>
        <div>
          <label class="block text-sm font-medium">النص</label>
          <select id="ddCaption" class="w-full p-2 border rounded"></select>
          <textarea id="msgText" class="w-full p-2 border rounded mt-2 h-28" placeholder="أو اكتب رسالتك"></textarea>
        </div>
        <div class="flex flex-wrap items-end gap-3">
          <div>
            <label class="block text-sm font-medium">الفاصل (ثانية)</label>
            <input id="delay" type="number" value="5" min="1" class="w-28 p-2 border rounded" />
          </div>
          <button id="btnStart"  class="px-4 py-2 bg-blue-600 text-white rounded">بدء الإرسال</button>
          <button id="btnPause"  class="px-4 py-2 bg-yellow-500 text-white rounded">إيقاف مؤقت</button>
          <button id="btnResume" class="px-4 py-2 bg-green-600 text-white rounded">استئناف</button>
          <button id="btnStop"   class="px-4 py-2 bg-red-600 text-white rounded">إيقاف نهائي</button>
          <span class="ml-auto text-sm">التقدم: <b id="sendProg">0/0</b></span>
        </div>
      </div>
      <div class="glass p-4">
        <div class="font-bold">قائمة الإرسال (<span id="targetCount">0</span>)</div>
        <div id="sendList" class="mt-3 space-y-2 max-h-[50vh] overflow-y-auto"></div>
      </div>
    </div>
  </template>

  <template id="tpl-reports">
    <div id="reportsWrap" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="noReports" class="hidden text-center text-gray-500 mt-8">لا توجد تقارير بعد.</p>
  </template>

  <template id="tpl-settings">
    <div class="max-w-xl space-y-4">
      <div class="glass p-6">
        <div class="font-bold text-lg mb-3">إعدادات الاتصال</div>
        <div class="space-y-3">
          <input id="pageId" class="w-full p-2 border rounded" placeholder="Page ID" />
          <input id="accessToken" class="w-full p-2 border rounded" placeholder="Page Access Token" />
          <button id="btnConnect" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حفظ والاتصال</button>
        </div>
      </div>
      <div class="glass p-6">
        <div class="font-bold mb-2">جلسة المستخدم</div>
        <div class="flex items-center gap-3">
          <span>admin</span>
          <button id="btnLogout" class="px-4 py-2 bg-gray-700 text-white rounded-lg">تسجيل الخروج</button>
          <button id="btnClearCache" class="px-4 py-2 bg-red-700 text-white rounded-lg">تفريغ كل البيانات</button>
        </div>
      </div>
    </div>
  </template>

  <div id="modal" class="hidden fixed inset-0 bg-black/50 z-[60] items-center justify-center">
    <div class="glass p-6 max-w-md w-full">
      <h4 id="mTitle" class="font-bold text-lg mb-2"></h4>
      <p id="mMsg" class="text-gray-700 whitespace-pre-wrap"></p>
      <div class="text-left mt-4"><button id="mOk" class="px-4 py-2 bg-blue-600 text-white rounded-lg">حسنًا</button></div>
    </div>
  </div>

  <script>
    // ====== Local state (no Firebase)
    const LS = {
      get: (k, d) => { try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      del: (k) => localStorage.removeItem(k)
    };
    const ST = {
      connected: false,
      pageId: LS.get('lc_pageId', null),
      token:  LS.get('lc_token', null),

      users:  LS.get('lc_users', []),          // [{id,name,picture}]
      audiences: LS.get('lc_audiences', []),   // [{id,name,userIds:[]}]
      images: LS.get('lc_images', []),         // [{id,name,url(Base64)}]
      captions: LS.get('lc_captions', []),     // [{id,name,text}]

      // fetch state (persistent)
      fetching: LS.get('lc_fetching', {running:false, paused:false, next:null, page:0}),
      fetchAdded: 0,

      // sending state (persistent)
      sending: LS.get('lc_sending', {running:false, paused:false, idx:0, targets:[], job:null, delay:5})
    };

    // ====== Helpers/UI
    const $  = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
    function toast(title, msg){
      $('#mTitle').textContent = title; $('#mMsg').textContent = msg||'';
      $('#modal').classList.remove('hidden'); $('#mOk').onclick = ()=>$('#modal').classList.add('hidden');
    }
    function setConnectedUI(yes, name){
      $('#pageName').textContent = yes ? (name||'متصل') : 'غير متصل';
      $('#statusDot').classList.toggle('bg-green-500', yes);
      $('#statusDot').classList.toggle('bg-red-500', !yes);
      $('#bannerDisconnected').classList.toggle('hidden', yes);
    }
    function savePersist(){
      LS.set('lc_users', ST.users);
      LS.set('lc_audiences', ST.audiences);
      LS.set('lc_images', ST.images);
      LS.set('lc_captions', ST.captions);
      LS.set('lc_fetching', ST.fetching);
      LS.set('lc_sending', ST.sending);
    }

    // ====== Login (local only)
    function doLogin(){
      const u = $('#adminUser').value.trim();
      const p = $('#adminPass').value.trim();
      if(u==='admin' && p==='mO..012842'){
        localStorage.setItem('lc_logged','1');
        $('#loginOverlay').classList.add('hidden');
        $('#app').classList.remove('hidden');
        initAfterLogin();
      }else{
        $('#loginError').classList.remove('hidden');
      }
    }

    // ====== Router/Views
    const views = {
      dashboard(root){
        root.innerHTML = $('#tpl-dashboard').innerHTML;
        $('#statTotal').textContent = ST.users.length;
        const totalSaved = ST.audiences.reduce((a,c)=>a+(c.userIds?.length||0),0);
        $('#statSaved').textContent = totalSaved;
        const sent = (LS.get('lc_reports', [])).reduce((a,c)=>a+(c.successCount||0),0);
        const tot  = (LS.get('lc_reports', [])).reduce((a,c)=>a+((c.successCount||0)+(c.failureCount||0)),0);
        $('#statSent').textContent = sent;
        $('#statRate').textContent = tot? Math.round((sent/tot)*100)+'%':'0%';
      },
      audience(root){
        root.innerHTML = $('#tpl-audience').innerHTML;
        bindAudienceUI();
        renderAudienceTable();
        renderSavedAudiences();
        updateFetchBadges();
      },
      content(root){
        root.innerHTML = $('#tpl-content').innerHTML;
        $('#btnSaveImg').onclick = saveImage;
        $('#btnSaveCap').onclick = saveCaption;
        renderImgs(); renderCaps();
      },
      campaigns(root){
        root.innerHTML = $('#tpl-campaigns').innerHTML;
        fillCampaignDropdowns();
        bindCampaignControls();
        updateSendProgress();
      },
      reports(root){
        root.innerHTML = $('#tpl-reports').innerHTML;
        renderReports();
      },
      settings(root){
        root.innerHTML = $('#tpl-settings').innerHTML;
        $('#pageId').value     = ST.pageId || '';
        $('#accessToken').value= ST.token  || '';
        $('#btnConnect').onclick = () => connect($('#pageId').value.trim(), $('#accessToken').value.trim());
        $('#btnLogout').onclick  = () => { localStorage.removeItem('lc_logged'); location.reload(); };
        $('#btnClearCache').onclick = () => { if(confirm('تفريغ كل البيانات المحلية؟')){ localStorage.clear(); location.reload(); } };
      }
    };

    function render(){
      const v = (location.hash||'#dashboard').slice(1);
      $$('.nav-item').forEach(a=>a.classList.remove('active'));
      $('#nav'+v.charAt(0).toUpperCase()+v.slice(1))?.classList.add('active');
      $('#pageTitle').textContent = $('#nav'+v.charAt(0).toUpperCase()+v.slice(1))?.textContent || '';
      views[v]?.($('#viewRoot'));
    }
    window.addEventListener('hashchange', render);

    // ====== Connect to Graph
    async function connect(pageId, token){
      if(!pageId || !token) return toast('خطأ','أدخل Page ID و Access Token');
      try{
        const res = await fetch(`https://graph.facebook.com/v20.0/${pageId}?fields=name,picture.type(small)&access_token=${encodeURIComponent(token)}`);
        const data = await res.json();
        if(!res.ok || data.error) throw new Error(data.error?.message || ('HTTP '+res.status));
        ST.pageId = pageId; ST.token = token; ST.connected = true;
        LS.set('lc_pageId', pageId); LS.set('lc_token', token);
        setConnectedUI(true, data.name);
        toast('تم الاتصال', `متصل الآن بصفحة ${data.name}`);
      }catch(e){
        setConnectedUI(false);
        toast('فشل الاتصال', e.message);
      }
    }

    // ====== Audience (fetch / save / import / export)
    function bindAudienceUI(){
      $('#btnFetchStart').onclick = fetchStart;
      $('#btnFetchPause').onclick = fetchPause;
      $('#btnFetchResume').onclick= fetchResume;
      $('#btnFetchStop').onclick  = fetchStop;

      $('#btnSaveAud').onclick    = saveSelectedAudience;
      $('#btnExportCSV').onclick  = exportCSV;
      $('#btnClearAll').onclick   = () => { if(confirm('حذف كل الجمهور؟')){ ST.users = []; savePersist(); renderAudienceTable(); } };

      $('#btnApplyFilter').onclick= applyFilter;
      $('#btnResetFilter').onclick= ()=>{ $('#filterTxt').value=''; renderAudienceTable(); };

      $('#btnImportIds').onclick  = importIds;
      $('#btnClearImport').onclick= ()=> $('#idsImport').value='';
    }
    function updateFetchBadges(){
      $('#audCount').textContent = ST.users.length;
      $('#selCount').textContent = ST._selectedCount || 0;
      $('#fetchState').textContent= ST.fetching.running ? (ST.fetching.paused ? 'متوقف مؤقتًا' : 'يعمل') : 'متوقف';
      $('#fetchPage').textContent = ST.fetching.page || '—';
      $('#fetchAdded').textContent= ST.fetchAdded || 0;
    }
    function renderAudienceTable(filter=''){
      const body = $('#audTable'); body.innerHTML='';
      const rows = (filter? ST.users.filter(u => (u.name||'').includes(filter) || (u.id||'').includes(filter)) : ST.users);
      rows.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2"><input type="checkbox" data-id="${u.id}"></td>
                        <td class="p-2"><div class="flex items-center gap-2">
                          <img src="${u.picture||'https://placehold.co/40'}" class="w-8 h-8 rounded"/><b>${u.name||'User'}</b></div></td>
                        <td class="p-2 mono text-gray-700">${u.id}</td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.onchange = (e)=>{
        const id = e.target.dataset.id;
        if(!ST._selected) ST._selected = new Set();
        if(e.target.checked) ST._selected.add(id); else ST._selected.delete(id);
        ST._selectedCount = ST._selected.size;
        updateFetchBadges();
      });
      updateFetchBadges();
    }
    function applyFilter(){ renderAudienceTable($('#filterTxt').value.trim()); }

    function exportCSV(){
      const rows = [['id','name','picture']].concat(ST.users.map(u=>[u.id||'', u.name||'', u.picture||'']));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      const a = document.createElement('a'); a.href=url; a.download='audience.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function importIds(){
      const lines = $('#idsImport').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(lines.length===0) return;
      const seen = new Set(ST.users.map(u=>u.id));
      let added=0;
      lines.forEach(id=>{ if(!seen.has(id)){ seen.add(id); ST.users.push({id, name:'User', picture:'https://placehold.co/40'}) ; added++; }});
      ST.fetchAdded += added;
      savePersist(); renderAudienceTable(); updateFetchBadges();
      toast('تم الاستيراد', `أضيف ${added} معرفًا.`);
    }

    async function fetchLoop(){
      let backoff = 2; // ثواني (يزيد لو في Rate Limit)
      while(ST.fetching.running && !ST.fetching.paused && ST.fetching.next){
        try{
          const res = await fetch(ST.fetching.next);
          const data = await res.json();
          if(data.error){
            // لو Rate limit (code 4/613) نزود الباك أوف
            if(String(data.error.code).includes('613') || String(data.error.code).includes('4')){
              await new Promise(r=>setTimeout(r, backoff*1000)); backoff = Math.min(backoff*2, 60);
              continue;
            }
            throw new Error(data.error.message);
          }
          backoff = 2;
          const seen = new Set(ST.users.map(u=>u.id));
          (data.data||[]).forEach(conv=>{
            const u = (conv.participants?.data||[]).find(p=>p.id!==ST.pageId);
            if(u && !seen.has(u.id)){ seen.add(u.id); ST.users.push({id:u.id, name:u.name, picture:u.picture?.data?.url}); ST.fetchAdded++; }
          });
          ST.fetching.next = data.paging?.next || null;
          ST.fetching.page = (ST.fetching.page||0)+1;
          savePersist();
          renderAudienceTable($('#filterTxt')?.value||'');
          updateFetchBadges();
          // تهوية بسيطة بين الصفحات
          await new Promise(r=>setTimeout(r, 800));
          if(!ST.fetching.next) { ST.fetching.running=false; savePersist(); updateFetchBadges(); toast('انتهى السحب','لا مزيد من الصفحات.'); }
        }catch(e){
          ST.fetching.running=false; savePersist(); updateFetchBadges();
          toast('خطأ في السحب', e.message||String(e));
        }
      }
    }
    function fetchStart(){
      if(!ST.connected) return toast('غير متصل','أدخل الإعدادات أولاً.');
      ST.fetching.running=true; ST.fetching.paused=false;
      ST.fetching.next = `https://graph.facebook.com/v20.0/${ST.pageId}/conversations?fields=participants{name,id,picture.type(square)}&limit=100&access_token=${encodeURIComponent(ST.token)}`;
      ST.fetching.page=0; ST.fetchAdded=0;
      savePersist(); updateFetchBadges(); fetchLoop();
    }
    function fetchPause(){ if(ST.fetching.running){ ST.fetching.paused=true; savePersist(); updateFetchBadges(); } }
    function fetchResume(){ if(ST.fetching.next){ ST.fetching.paused=false; ST.fetching.running=true; savePersist(); updateFetchBadges(); fetchLoop(); } }
    function fetchStop(){ ST.fetching.running=false; ST.fetching.paused=false; savePersist(); updateFetchBadges(); }

    function renderSavedAudiences(){
      const box = $('#audSaved'); if(!box) return; box.innerHTML='';
      ST.audiences.forEach(a=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between py-1';
        row.innerHTML = `<div><b>${a.name}</b> <span class="text-gray-500 text-sm">(${a.userIds.length})</span></div>
                         <button class="text-red-600" data-id="${a.id}">حذف</button>`;
        row.querySelector('button').onclick = ()=>{ ST.audiences = ST.audiences.filter(x=>x.id!==a.id); savePersist(); renderSavedAudiences(); };
        box.appendChild(row);
      });
    }
    function saveSelectedAudience(){
      const ids = ST._selected ? Array.from(ST._selected) : [];
      if(ids.length===0) return toast('خطأ','حدد مستخدمين أولاً.');
      const name = prompt('اسم القائمة:'); if(!name) return;
      ST.audiences.push({id: crypto.randomUUID(), name, userIds: ids});
      savePersist(); renderSavedAudiences(); ST._selected.clear(); ST._selectedCount=0; updateFetchBadges();
      toast('تم','تم حفظ القائمة.');
    }

    // ====== Content (localStorage)
    function renderImgs(){
      const list = $('#imgList'); list.innerHTML='';
      ST.images.forEach(img=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between py-1';
        row.innerHTML = `<div class="flex items-center gap-2">
            <img src="${img.url}" class="w-10 h-10 rounded object-cover"><b>${img.name}</b></div>
          <button class="text-red-600" data-id="${img.id}">حذف</button>`;
        row.querySelector('button').onclick = ()=>{ ST.images = ST.images.filter(x=>x.id!==img.id); savePersist(); renderImgs(); };
        list.appendChild(row);
      });
    }
    function renderCaps(){
      const list = $('#capList'); list.innerHTML='';
      ST.captions.forEach(c=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between py-1';
        row.innerHTML = `<div><b>${c.name}</b><div class="text-gray-500 text-sm max-w-sm truncate">${c.text}</div></div>
          <button class="text-red-600" data-id="${c.id}">حذف</button>`;
        row.querySelector('button').onclick = ()=>{ ST.captions = ST.captions.filter(x=>x.id!==c.id); savePersist(); renderCaps(); };
        list.appendChild(row);
      });
    }
    function saveImage(){
      const name = $('#imgName').value.trim();
      const file = $('#imgFile').files[0];
      if(!name || !file) return;
      const reader = new FileReader();
      reader.onload = () => {
        ST.images.push({id: crypto.randomUUID(), name, url: reader.result});
        savePersist(); renderImgs();
        $('#imgName').value=''; $('#imgFile').value='';
      };
      reader.readAsDataURL(file);
    }
    function saveCaption(){
      const name = $('#capName').value.trim();
      const text = $('#capText').value.trim();
      if(!name || !text) return;
      ST.captions.push({id: crypto.randomUUID(), name, text});
      savePersist(); renderCaps();
      $('#capName').value=''; $('#capText').value='';
    }

    // ====== Campaigns (direct browser → Graph) with pause/resume
    function fillCampaignDropdowns(){
      const ddA = $('#ddAudience'); ddA.innerHTML = `<option value="">-- اختر جمهورًا --</option>`;
      ST.audiences.forEach(a=> ddA.add(new Option(`${a.name} (${a.userIds.length})`, a.id)));
      const ddI = $('#ddImage'); ddI.innerHTML = `<option value="">-- اختر صورة --</option>`;
      ST.images.forEach(img=> ddI.add(new Option(img.name, img.id)));
      ddI.onchange = ()=>{ const img = ST.images.find(i=>i.id===ddI.value); if(img) $('#imgUrl').value = img.url; };
      const ddC = $('#ddCaption'); ddC.innerHTML = `<option value="">-- اختر نصًا --</option>`;
      ST.captions.forEach(c=> ddC.add(new Option(c.name, c.id)));
      ddC.onchange = ()=>{ const c = ST.captions.find(x=>x.id===ddC.value); if(c) $('#msgText').value = c.text; };
      renderSendList([]);
    }
    function renderSendList(ids){
      $('#sendList').innerHTML='';
      ids.forEach(id=>{
        const div = document.createElement('div'); div.className='flex items-center justify-between p-2 border rounded';
        const u = ST.users.find(x=>x.id===id) || {name:'User', picture:'https://placehold.co/40'};
        div.innerHTML = `<div class="flex items-center gap-2"><img class="w-8 h-8 rounded" src="${u.picture}"><b>${u.name}</b></div>
                         <span id="st-${id}" class="text-sm text-gray-500">—</span>`;
        $('#sendList').appendChild(div);
      });
      $('#targetCount').textContent = ids.length;
    }
    function bindCampaignControls(){
      $('#btnStart').onclick = startCampaign;
      $('#btnPause').onclick = ()=>{ ST.sending.paused=true; savePersist(); };
      $('#btnResume').onclick= ()=>{ ST.sending.paused=false; savePersist(); runSender(); };
      $('#btnStop').onclick  = ()=>{ ST.sending.running=false; ST.sending.paused=false; savePersist(); updateSendProgress(); };
    }
    function updateSendProgress(){
      $('#sendProg').textContent = `${ST.sending.idx}/${ST.sending.targets.length}`;
    }
    async function startCampaign(){
      if(!ST.connected) return toast('غير متصل','أدخل الإعدادات أولاً.');
      const audId = $('#ddAudience').value;
      const audience = ST.audiences.find(a=>a.id===audId);
      if(!audience || audience.userIds.length===0) return toast('خطأ','اختر جمهورًا صحيحًا.');
      const message = $('#msgText').value.trim();
      const imageUrl = $('#imgUrl').value.trim();
      if(!message && !imageUrl) return toast('خطأ','أدخل رسالة أو صورة.');
      const delay = Math.max(1, parseInt($('#delay').value||'5',10));

      ST.sending = {running:true, paused:false, idx:0, targets:[...audience.userIds], job:{
        id: crypto.randomUUID(), name:`Campaign ${new Date().toLocaleString()}`, createdAt: Date.now(), successCount:0, failureCount:0
      }, delay};
      savePersist();

      renderSendList(ST.sending.targets);
      runSender(message, imageUrl, delay);
    }
    async function runSender(message=null, imageUrl=null, delay=null){
      // لو تم الاستئناف بعد إعادة تحميل
      if(message===null)  message  = $('#msgText')?.value?.trim() || '';
      if(imageUrl===null) imageUrl = $('#imgUrl')?.value?.trim() || '';
      if(delay===null)    delay    = Math.max(1, parseInt($('#delay')?.value||ST.sending.delay||'5',10));

      const url = `https://graph.facebook.com/v20.0/me/messages?access_token=${encodeURIComponent(ST.token)}`;
      let backoff = 2;
      while(ST.sending.running && ST.sending.idx < ST.sending.targets.length){
        if(ST.sending.paused){ savePersist(); await new Promise(r=>setTimeout(r, 500)); continue; }
        const id = ST.sending.targets[ST.sending.idx];
        $('#st-'+id)?.classList.remove('text-gray-500'); $('#st-'+id)?.classList.add('text-yellow-700'); $('#st-'+id).textContent='...';
        try{
          const payload = { messaging_type:'RESPONSE', recipient:{id}, message:{} };
          if(message)  payload.message.text = message;
          if(imageUrl) payload.message.attachment = { type:'image', payload:{ url:imageUrl, is_reusable:true } };

          const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const data = await res.json();
          if(data.error){
            // Rate limit backoff
            if(String(data.error.code).includes('613') || String(data.error.code).includes('4')){
              await new Promise(r=>setTimeout(r, backoff*1000)); backoff = Math.min(backoff*2, 60);
              continue; // أعد المحاولة لنفس الهدف
            }
            throw new Error(data.error.message);
          }
          backoff = 2;
          ST.sending.job.successCount++;
          $('#st-'+id).textContent='✅'; $('#st-'+id).className='text-green-700';
        }catch(e){
          ST.sending.job.failureCount++;
          $('#st-'+id).textContent='❌'; $('#st-'+id).className='text-red-700';
        }
        ST.sending.idx++;
        savePersist(); updateSendProgress();
        await new Promise(r=>setTimeout(r, delay*1000));
      }
      if(ST.sending.idx >= ST.sending.targets.length){
        const reports = LS.get('lc_reports', []);
        reports.push(ST.sending.job); LS.set('lc_reports', reports);
        ST.sending.running=false; ST.sending.paused=false; savePersist();
        toast('انتهى الإرسال', `تم: ${ST.sending.job.successCount}\nفشل: ${ST.sending.job.failureCount}`);
      }
    }

    // ====== Reports
    function renderReports(){
      const wrap = $('#reportsWrap'); const empty = $('#noReports');
      const reports = LS.get('lc_reports', []);
      wrap.innerHTML=''; if(reports.length===0){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      reports.slice().reverse().forEach(c=>{
        const total = (c.successCount||0)+(c.failureCount||0);
        const card = document.createElement('div'); card.className='glass p-4';
        card.innerHTML = `<div class="flex items-center justify-between">
          <b>${c.name||'Campaign'}</b><span class="text-sm">${new Date(c.createdAt).toLocaleString()}</span></div>
          <div class="mt-2 text-sm text-gray-700">تم: ${c.successCount||0} — فشل: ${c.failureCount||0} — الإجمالي: ${total}</div>`;
        wrap.appendChild(card);
      });
    }

    // ====== Boot
    function initAfterLogin(){
      setConnectedUI(!!ST.token && !!ST.pageId, null);
      if(ST.fetching.running && !ST.fetching.paused && ST.fetching.next) fetchLoop();
      if(ST.sending.running && !ST.sending.paused){
        renderSendList(ST.sending.targets);
        runSender();
      }
      window.dispatchEvent(new HashChangeEvent('hashchange'));
    }

    // events
    $('#adminLoginBtn').onclick = doLogin;
    $('#adminPass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });
    $('#mOk').onclick = ()=> $('#modal').classList.add('hidden');

    if(localStorage.getItem('lc_logged')==='1'){
      $('#loginOverlay').classList.add('hidden'); $('#app').classList.remove('hidden'); initAfterLogin();
    }else{
      $('#app').classList.add('hidden');
    }
    render(); // initial
  </script>
</body>
</html>
